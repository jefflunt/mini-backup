#!/bin/bash

if [ "$#" -ne 2 ]; then
  echo "Usage"
  echo "  backup catalog-file destination-folder>"
else
  cat $1 | while read line; do
    SHA=$(echo $line | cut -f 1 -d ' ')
    FILENAME="$(echo $line | cut -c66-)"

    DEST=$2$SHA

    if [ ! -f "$DEST.tar.gz" ]; then
      cp "$FILENAME" $DEST

      COPY_SHA=$(shasum -a 256 $DEST | cut -f 1 -d ' ')
      if [ "$SHA" != "$COPY_SHA" ]; then
        echo "FAIL: $FILENAME"
      else
        tar -czf $DEST.tar.gz $DEST
        rm $DEST
      fi
    fi
  done
fi
